# Copyright 2010 Michael Thomas <aelmalinka@gmail.com>
# Distributed under the terms of the GNU General Public Licesnse v2

myexparam gyp_revision=""

require github [ user=v8 ]

if ever is_scm; then
    SCM_gyp_REPOSITORY="https://github.com/svn2github/gyp"
    [[ "$(exparam gyp_revision)" ]] && SCM_gyp_REVISION=$(exparam gyp_revision)
    SCM_gyp_UNPACK_TO="${WORK}/build/gyp"

    SCM_SECONDARY_REPOSITORIES="gyp"
else
    SCM_REPOSITORY="https://github.com/svn2github/gyp"
    [[ "$(exparam gyp_revision)" ]] && SCM_REVISION=$(exparam gyp_revision)
    SCM_UNPACK_TO="${WORK}/build/gyp"

    require scm-git

    export_exlib_phases src_unpack
fi

export_exlib_phases src_prepare src_compile src_install src_test

SUMMARY="Google V8 Javascript engine"
DESCRIPTION="Implements ECMAScript as specified in ECMA-262, 3rd Edition, runs standalone or embedded into any C++ Application"

LICENCES="BSD-3"

MYOPTIONS="
    platform:
        x86
        amd64
"

DEPENDENCIES="
    build:
        dev-lang/python:*[<3.0]
"

v8_platform() {
    if option "platform:amd64" ; then
        echo "x64"
    elif option "platform:x86" ; then
        echo "ia32"
    fi
}

if ! ever is_scm; then
v8_src_unpack() {
    default

    scm_src_unpack
}
fi

v8_src_prepare() {
    edo sed -i -e 's:#!/usr/bin/env python:#!/usr/bin/env python2:' \
        build/gyp/gyp \
        tools/run-tests.py
    edo sed -i -e 's/python/python2/' Makefile
}

v8_src_compile() {
    LD="${CXX}" emake \
        V=1 \
        werror=no \
        "library=shared" \
        $(v8_platform).release
}

v8_src_install() {
    insinto /usr/$(exhost --target)
    doins -r include

    pushd "${WORK}/out/$(v8_platform).release"

    pushd "lib.target"
    dolib libv8.so
    popd

    dobin d8
    popd

    emagicdocs

    if ever at_least scm ; then edo rm -rf "${IMAGE}/usr/include/.svn" ; fi
}

v8_src_test() {
    emake \
        V=1 \
        werror=no \
        "library=shared" \
        TESTFLAGS="--no-presubmit" \
        $(v8_platform).release.check
}
